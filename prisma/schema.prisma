generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. MODEL USER (Ng∆∞·ªùi d√πng)
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  fullName  String   @map("full_name")
  phone     String?
  avatar    String?
  role      Role     @default(GUEST)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Quan h·ªá
  properties       Properties[] // C√°c ph√≤ng do Host n√†y ƒëƒÉng
  bookings         Booking[] // C√°c ƒë∆°n do Guest n√†y ƒë·∫∑t
  reviews          Review[] // C√°c review ƒë√£ vi·∫øt
  sentMessages     Message[]    @relation("Sender")
  receivedMessages Message[]    @relation("Receiver")

  @@map("users")
}

// Enum cho quy·ªÅn h·∫°n
enum Role {
  GUEST
  HOST
  ADMIN
}

// 2. MODEL PROPERTY (CƒÉn h·ªô/Ph√≤ng)
model Properties {
  id            Int            @id @default(autoincrement())
  ownerId       Int            @map("owner_id")
  title         String
  description   String?        @db.Text
  pricePerNight Decimal        @map("price_per_night") @db.Decimal(10, 2)
  address       String
  latitude      Float?
  longitude     Float?
  status        PropertyStatus @default(ACTIVE)
  images        String[] // L∆∞u danh s√°ch c√°c ƒë∆∞·ªùng link ·∫£nh (D·∫°ng M·∫£ng)
  createdAt     DateTime       @default(now()) @map("created_at")

  // Quan h·ªá
  owner     User              @relation(fields: [ownerId], references: [id])
  bookings  Booking[]
  amenities PropertyAmenity[]

  @@map("properties")
}

enum PropertyStatus {
  ACTIVE
  INACTIVE
}

// 3. MODEL BOOKING (ƒê∆°n ƒë·∫∑t ph√≤ng)
enum BookingStatus {
  PENDING // Ch·ªù x√°c nh·∫≠n
  CONFIRMED // ƒê√£ x√°c nh·∫≠n
  CANCELLED // ƒê√£ h·ªßy
  COMPLETED // ƒê√£ ho√†n th√†nh (Check-out xong)
}

model Booking {
  id Int @id @default(autoincrement())

  checkIn  DateTime @map("check_in")
  checkOut DateTime @map("check_out")

  totalPrice Decimal       @map("total_price") @db.Decimal(12, 2)
  status     BookingStatus @default(PENDING)

  guestId    Int @map("guest_id")
  propertyId Int @map("property_id")

  createdAt DateTime @default(now()) @map("created_at")

  // Quan h·ªá
  guest    User       @relation(fields: [guestId], references: [id])
  property Properties @relation(fields: [propertyId], references: [id])

  // üëá ƒê√É S·ª¨A: M·ªü comment 2 d√≤ng n√†y ra ƒë·ªÉ k·∫øt n·ªëi v·ªõi b·∫£ng Payment v√† Review
  payment Payment?
  review  Review?

  @@map("bookings")
}

// 4. MODEL PAYMENT (Thanh to√°n)
model Payment {
  id              Int           @id @default(autoincrement())
  bookingId       Int           @unique @map("booking_id") // 1 Booking ch·ªâ c√≥ 1 Payment
  amount          Decimal       @db.Decimal(12, 2)
  provider        String // VNPAY, STRIPE
  transactionCode String?       @map("transaction_code")
  status          PaymentStatus @default(SUCCESS)
  paymentDate     DateTime      @default(now()) @map("payment_date")

  // Quan h·ªá
  booking Booking @relation(fields: [bookingId], references: [id])

  @@map("payments")
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

// 5. MODEL REVIEW (ƒê√°nh gi√°)
model Review {
  id        Int      @id @default(autoincrement())
  bookingId Int      @unique @map("booking_id") // 1 Booking ch·ªâ c√≥ 1 Review
  userId    Int      @map("user_id") // Ng∆∞·ªùi vi·∫øt review
  rating    Int // 1-5 sao
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  // Quan h·ªá
  booking Booking @relation(fields: [bookingId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@map("reviews")
}

// 6. MODEL MESSAGE (Chat)
model Message {
  id         Int      @id @default(autoincrement())
  senderId   Int      @map("sender_id")
  receiverId Int      @map("receiver_id")
  content    String   @db.Text
  isRead     Boolean  @default(false) @map("is_read")
  sentAt     DateTime @default(now()) @map("sent_at")

  // Quan h·ªá
  sender   User @relation("Sender", fields: [senderId], references: [id])
  receiver User @relation("Receiver", fields: [receiverId], references: [id])

  @@map("messages")
}

// 7. MODEL AMENITIES & B·∫£ng trung gian
model Amenity {
  id      Int     @id @default(autoincrement())
  name    String
  iconUrl String? @map("icon_url")

  properties PropertyAmenity[]

  @@map("amenities")
}

model PropertyAmenity {
  propertyId Int @map("property_id")
  amenityId  Int @map("amenity_id")

  property Properties @relation(fields: [propertyId], references: [id])
  amenity  Amenity    @relation(fields: [amenityId], references: [id])

  @@id([propertyId, amenityId]) // Kh√≥a ch√≠nh ph·ª©c h·ª£p
  @@map("property_amenities")
}